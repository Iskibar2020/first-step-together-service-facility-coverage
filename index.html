<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leaflet Map with Live Coordinates</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" />
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        #coords {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.8);
            padding: 4px 8px;
            font-size: 12px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
        }

        .city-label {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            font-weight: 600;
            font-size: 11px;
            color: #000000;
            text-shadow:
                0 0 4px rgb(255, 255, 255),
                0 0 4px rgb(255, 255, 255),
                0 0 4px rgb(255, 255, 255),
                0 0 4px rgb(255, 255, 255);
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="coords">Lat: —, Lng: —</div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
    <script>
        const map = L.map('map').setView([42.4072, -71.3824], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        const coordsDiv = document.getElementById('coords');

        map.on('mousemove', function (e) {
            const { lat, lng } = e.latlng;
            coordsDiv.textContent = `Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`;
        });

        const cityStyle = {
            color: "grey",
            weight: 1,
            opacity: 1,
            fillColor: "darkgrey",
            fillOpacity: 0.25
        };

        const regionStyle = {
            color: "#ff0000",
            weight: 3,
            opacity: 0.8,
            fillColor: "#3388ff",
            fillOpacity: 0.2
        };

        function updateLabelVisibility() {
            const zoom = map.getZoom();
            const labels = document.querySelectorAll('.city-label');
            labels.forEach(label => {
                label.style.opacity = zoom >= 10 ? 1 : 0;
            });
        }

        map.on('zoomend', updateLabelVisibility);

        // Load city labels
        fetch('https://iskibar2020.github.io/turkish_region_api/city.geojson')
            .then(response => response.json())
            .then(cityData => {
                L.geoJSON(cityData, {
                    style: cityStyle,
                    onEachFeature: function (feature, layer) {
                        if (feature.properties.TOWN) {
                            layer.bindTooltip(feature.properties.TOWN, {
                                permanent: true,
                                direction: 'center',
                                className: 'city-label',
                                interactive: false
                            });
                        }
                    }
                }).addTo(map);
                updateLabelVisibility();
            })
            .catch(error => console.error('Error loading city data:', error));

        // Load regional data with popups
        fetch('https://iskibar2020.github.io/turkish_region_api/regional.geojson')
            .then(response => response.json())
            .then(regionalData => {
                const regions = L.geoJSON(regionalData, {
                    style: regionStyle,
                    onEachFeature: function (feature, layer) {
                        if (feature.properties.Region) {
                            let cityListHtml = '';
                            if (Array.isArray(feature.properties.Cities)) {
                                cityListHtml = '<hr>Cities:<ul style="padding-left:1em;margin:0;">' +
                                    feature.properties.Cities.map(city => {
                                        return `<li style="margin:2px 0;">
                      <a href="#" 
                         style="text-decoration: none; color: gray;"
                         onmouseover="this.style.color='maroon';" 
                         onmouseout="this.style.color='gray';"
                         onclick="zoomToCity(${city.coords[0]}, ${city.coords[1]}, '${city.name.replace(/'/g, "\\'")}'); return false;">
                        ${city.name}
                      </a>
                    </li>`;
                                    }).join('') +
                                    '</ul>';
                            }

                            const popupHtml = `
                <div>
                  <strong>${feature.properties.AreaName}</strong><br>
                  <em>${feature.properties.Title}</em><br>
                  ${cityListHtml}
                </div>
              `;
                            layer.bindPopup(popupHtml);
                        }
                    }
                }).addTo(map);

                map.fitBounds(regions.getBounds());
            })
            .catch(error => {
                console.error('Error loading regional data:', error);
                alert('Error loading map data.');
            });

        function zoomToCity(lat, lng, name) {
            map.setView([lat, lng], 13);
            L.circleMarker([lat, lng], {
                radius: 6,
                fillColor: '#f03',
                fillOpacity: 0.6,
                color: '#900'
            })
                .bindPopup(`<strong>${name}</strong>`)
                .addTo(map)
                .openPopup();
        }
    </script>
</body>

</html>
